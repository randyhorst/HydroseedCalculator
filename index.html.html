<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Work Order Form</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Set up Inter font */
        body {
            font-family: 'Inter', sans-serif;
            /* Dark background color for dark mode */
            background-color: #1f2937; 
        }
        /* Custom print styles */
        @media print {
            /* Hide the main form and all controls when printing */
            .no-print {
                display: none !important;
            }
            /* Reset the body and print container for PDF generation */
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }
            /* Make the print container full width/height for a clean A4/Letter size printout */
            #print-preview {
                display: block !important;
                width: 100%;
                min-height: 100vh;
                box-shadow: none;
                padding: 30px; /* Add some padding for margins on the PDF page */
            }
            /* Ensure text wraps correctly in the report */
            .print-text {
                white-space: pre-wrap; /* Preserves formatting and line breaks from textarea */
                min-height: 200px; /* Ensure space is reserved for long text */
            }
            /* Hide the unit card border */
            .unit-card {
                border-bottom: none !important;
            }
            /* Ensure the attached photos print well */
            #report-photo-container img {
                width: 100%;
                max-width: 100%;
                height: auto;
                margin-top: 10px;
                page-break-inside: avoid; /* Try not to break an image across pages */
            }
            #report-photo-section {
                /* Add a page break *before* the photo section if it's too large to fit */
                break-before: auto;
            }
        }
        /* Ensure textareas look nice on mobile */
        textarea {
            resize: none;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-900 text-gray-100">

    <div id="app" class="max-w-3xl mx-auto">

        <!-- --- WORK ORDER INPUT FORM (no-print) --- -->
        <div id="form-view" class="no-print">
            
            <!-- Logo on App View (Uses Public URL) -->
            <div class="w-48 mx-auto mb-6">
                <img src="https://irp-cdn.multiscreensite.com/653de339/dms3rep/multi/opt/Pineview_Logo_Color-640w.png" alt="Pineview Logo" class="w-full h-auto">
            </div>
            
            <header class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-white">Work Order Entry</h1>
            </header>

            <div class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl space-y-6">

                <!-- Unit & Time Details -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 sm:col-span-1">
                        <label for="unit-number" class="block text-sm font-medium text-gray-300">Unit #</label>
                        <!-- Added appearance-none and inline style -->
                        <input type="text" id="unit-number" class="appearance-none mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" style="height: 48px;" placeholder="e.g., 4400, 101, etc.">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label for="employee-name" class="block text-sm font-medium text-gray-300">Employee Name</label>
                        <!-- Added appearance-none and inline style -->
                        <input type="text" id="employee-name" class="appearance-none mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" style="height: 48px;" placeholder="Your Name">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-300">Date</label>
                        <!-- Added appearance-none and inline style -->
                        <input type="date" id="date" class="appearance-none mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" style="height: 48px;">
                    </div>
                    <div>
                        <label for="hours" class="block text-sm font-medium text-gray-300">Hrs</label>
                        <!-- Added appearance-none and inline style -->
                        <input type="number" id="hours" class="appearance-none mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" style="height: 48px;" placeholder="0.0">
                    </div>
                    <div>
                        <label for="kilometers" class="block text-sm font-medium text-gray-300">Km</label>
                        <!-- Added appearance-none and inline style -->
                        <input type="number" id="kilometers" class="appearance-none mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" style="height: 48px;" placeholder="0">
                    </div>
                </div>

                <!-- What It Came In For -->
                <div>
                    <label for="came-in-for" class="block text-lg font-semibold text-white mb-2 mt-4">What It Came In For...</label>
                    <textarea id="came-in-for" rows="6" class="mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-4 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" placeholder="Describe the issue, requested work, or condition of the unit."></textarea>
                </div>

                <!-- What Got Done -->
                <div>
                    <label for="got-done" class="block text-lg font-semibold text-white mb-2 mt-4">What Got Done...</label>
                    <textarea id="got-done" rows="10" class="mt-1 block w-full rounded-lg border-gray-600 shadow-sm p-4 focus:border-indigo-500 focus:ring-indigo-500 border bg-gray-700 text-white" placeholder="Detail all work performed, parts used, and any next steps."></textarea>
                </div>

                <!-- Add Photos (Optional) -->
                <div>
                    <label for="photo-upload" class="block text-lg font-semibold text-white mb-2 mt-4">Add Photos (Optional)</label>
                    <!-- Added 'multiple' attribute -->
                    <input type="file" id="photo-upload" accept="image/*" multiple class="block w-full text-sm text-gray-300
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-600 file:text-white
                        hover:file:bg-indigo-700
                        file:cursor-pointer
                    ">
                    <!-- Photo Preview Area is now a grid container -->
                    <div id="photo-preview-container" class="mt-4 grid grid-cols-2 gap-4">
                        <!-- Preview images will be injected here by JavaScript -->
                    </div>
                </div>
                
                <!-- Action Button -->
                <div class="pt-4">
                    <button id="generate-button" onclick="generatePrintView()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Generate Print View (PDF)
                    </button>
                </div>

            </div>
        </div>

        <!-- --- PRINT PREVIEW / PDF REPORT (Hidden by default) --- -->
        
        <div id="print-preview" class="hidden bg-white rounded-xl shadow-2xl p-8">
            <div class="flex flex-col h-full">
                <!-- Header -->
                <header class="text-center border-b border-gray-400 pb-2 mb-6">
                    <div id="report-logo" class="w-32 mx-auto mb-4"> <!-- w-32 is smaller -->
                        <img src="https://irp-cdn.multiscreensite.com/653de339/dms3rep/multi/opt/Pineview_Logo_Color-640w.png" alt="Pineview Logo" class="w-full h-auto">
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900">Work Order</h1>
                </header>

                <!-- Unit Details Card -->
                <div class="unit-card flex justify-between text-sm mb-6 pb-2 border-b border-gray-300">
                    <div class="space-y-1">
                        <p><strong>Employee:</strong> <span id="report-employee" class="text-gray-800"></span></p>
                        <p><strong>Date:</strong> <span id="report-date" class="text-gray-800"></span></p>
                        <p><strong>Unit #:</strong> <span id="report-unit" class="text-gray-800"></span></p>
                    </div>
                    <div class="space-y-1 text-right">
                        <p><strong>Hrs:</strong> <span id="report-hours" class="text-gray-800"></span></p>
                        <p><strong>Km:</strong> <span id="report-kilometers" class="text-gray-800"></span></all>
                    </div>
                </div>

                <!-- What It Came In For -->
                <section class="mb-8 flex-grow">
                    <h2 class="text-base font-bold uppercase tracking-wider text-gray-700 mb-2 border-b border-gray-300 pb-1">What It Came In For...</h2>
                    <div id="report-came-in-for" class="print-text text-gray-800 text-sm leading-relaxed p-2 border border-gray-200 min-h-[150px] rounded-lg"></div>
                </section>

                <!-- What Got Done -->
                <section class="mb-8 flex-grow">
                    <h2 class="text-base font-bold uppercase tracking-wider text-gray-700 mb-2 border-b border-gray-300 pb-1">What Got Done...</h2>
                    <div id="report-got-done" class="print-text text-gray-800 text-sm leading-relaxed p-2 border border-gray-200 min-h-[250px] rounded-lg"></div>
                </section>

                <!-- Attached Photos Section (hidden by default) -->
                <section id="report-photo-section" class="hidden mb-8 flex-grow">
                    <h2 class="text-base font-bold uppercase tracking-wider text-gray-700 mb-2 border-b border-gray-300 pb-1">Attached Photos</h2>
                    <!-- Report photos will be injected here by JavaScript -->
                    <div id="report-photo-container" class="mt-4 grid grid-cols-1 gap-4"></div>
                </section>

                <!-- Print Controls (Visible only on screen, hidden when printing) -->
                <div class="no-print flex space-x-4 pt-6 mt-auto">
                    <button onclick="window.print()" class="flex-1 py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Save as PDF / Print
                    </button>
                    <button onclick="showFormView()" class="flex-1 py-3 px-4 border border-2 border-indigo-600 rounded-lg shadow-lg text-lg font-medium text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        &larr; Edit Details
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // State storage for the form data
        let formData = {};
        
        // Store blob URLs to revoke them later (good memory management)
        let currentPhotoURLs = [];

        // Helper to format the date for display
        const formatDate = (dateString) => {
            if (!dateString) return '';
            try {
                // Split yyyy-mm-dd
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString; // Fallback
                const year = parts[0];
                const monthIndex = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const day = parseInt(parts[2], 10);
                
                // Create date in UTC to avoid timezone shifts
                const dateObj = new Date(Date.UTC(year, monthIndex, day));
                
                const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
                return dateObj.toLocaleDateString(undefined, options);

            } catch (e) {
                return dateString; // Return original if parsing fails
            }
        };

        // Function to show the print preview and populate the data
        function generatePrintView() {
            // 1. Collect Data from Form
            formData = {
                unit: document.getElementById('unit-number').value.trim() || 'N/A',
                employee: document.getElementById('employee-name').value.trim() || 'N/A',
                date: document.getElementById('date').value.trim() || 'N/A',
                hours: document.getElementById('hours').value.trim() || '0.0',
                kilometers: document.getElementById('kilometers').value.trim() || '0',
                cameInFor: document.getElementById('came-in-for').value.trim() || 'No entry provided.',
                gotDone: document.getElementById('got-done').value.trim() || 'No work recorded.',
            };

            // Basic validation for the Unit Number
            if (formData.unit === 'N/A' || formData.unit === '') {
                document.getElementById('form-view').classList.add('border-4', 'border-red-500', 'p-2', 'rounded-xl');
                document.getElementById('unit-number').focus();
                alert('Please enter a Unit # before generating the report. This is needed for filing.');
                return;
            }
            document.getElementById('form-view').classList.remove('border-4', 'border-red-500', 'p-2', 'rounded-xl');

            // 2. Populate the Print Preview
            document.getElementById('report-unit').textContent = formData.unit;
            document.getElementById('report-employee').textContent = formData.employee;
            document.getElementById('report-date').textContent = formatDate(formData.date);
            document.getElementById('report-hours').textContent = formData.hours;
            document.getElementById('report-kilometers').textContent = formData.kilometers;
            document.getElementById('report-came-in-for').textContent = formData.cameInFor;
            document.getElementById('report-got-done').textContent = formData.gotDone;

            // 3. Handle Multiple Optional Photos
            const previewContainer = document.getElementById('photo-preview-container');
            const reportPhotoSection = document.getElementById('report-photo-section');
            const reportPhotoContainer = document.getElementById('report-photo-container');

            // Clear any old photos from the report
            reportPhotoContainer.innerHTML = '';
            
            const previewImages = previewContainer.querySelectorAll('img');

            if (previewImages.length > 0) {
                // If photos exist, show the section
                reportPhotoSection.classList.remove('hidden');
                
                // Loop through all preview images and copy them to the report
                for (const previewImage of previewImages) {
                    const reportImg = document.createElement('img');
                    reportImg.src = previewImage.src;
                    reportImg.className = 'w-full h-auto rounded-lg border border-gray-300';
                    reportPhotoContainer.appendChild(reportImg);
                }
            } else {
                // If no photos, hide the section
                reportPhotoSection.classList.add('hidden');
            }

            // 4. Switch Views
            document.getElementById('form-view').classList.add('hidden', 'no-print');
            document.getElementById('print-preview').classList.remove('hidden');
        }

        // Function to switch back to the form view
        function showFormView() {
            document.getElementById('print-preview').classList.add('hidden');
            document.getElementById('form-view').classList.remove('hidden', 'no-print');
            document.getElementById('unit-number').focus();
        }

        // Event listener for multiple photo uploads
        document.getElementById('photo-upload').addEventListener('change', function(event) {
            const previewContainer = document.getElementById('photo-preview-container');
            
            // Clear old previews and revoke old blob URLs
            previewContainer.innerHTML = '';
            currentPhotoURLs.forEach(url => URL.revokeObjectURL(url));
            currentPhotoURLs = []; // Reset the array

            if (event.target.files && event.target.files.length > 0) {
                for (const file of event.target.files) {
                    // Create a new blob URL
                    const photoURL = URL.createObjectURL(file);
                    currentPhotoURLs.push(photoURL); // Store it for later cleanup
                    
                    // Create and append the new image preview
                    const img = document.createElement('img');
                    img.src = photoURL;
                    img.className = 'w-full h-auto rounded-lg border-2 border-gray-600 object-cover';
                    previewContainer.appendChild(img);
                }
            }
        });

        // Initialize form with today's date
        window.onload = function() {
            const today = new Date();
            // Format to YYYY-MM-DD for the input[type="date"]
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
        };

        // A simple custom alert replacement function
        function alert(message) {
            if (document.getElementById('custom-alert')) return;
            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            alertDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
                    <h3 class="text-xl font-bold mb-3 text-red-600">Error</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">OK</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            alertDiv.querySelector('button').focus();
        }
    </script>
</body>
</html>